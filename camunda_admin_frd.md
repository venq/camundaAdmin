# FRD — Админка конфигурации пользовательских задач и сервис‑тасок (BPMN / Camunda 8 / Zeebe)

## 0. Назначение документа
Файл фиксирует **функциональные требования** к системе администрирования конфигураций пользовательских задач (UserTask) и сервис‑тасок (ServiceTask) для процессов на BPMN (Camunda 8 / Zeebe). Документ описывает, **что должна уметь система**, без предложений по реализации.

---

## 1. Термины и определения
- **Тенант (Tenant)** — логическая область, содержащая проекты и общие для них реестры.
- **Проект (Project)** — набор BPMN‑схем, процессов, задач и конфигураций внутри тенанта.
- **Окружение (Environment)** — стадия эксплуатации проекта (например: `dev`, `test`, `stage`, `prod`). Состав окружений настраивается **per‑tenant** и задаёт цепочку релизов.
- **BPMN** — нотация бизнес‑процессов. В системе — источник истины по нодам UserTask/ServiceTask.
- **UserTask** — пользовательская задача BPMN.
- **ServiceTask** — сервисная задача BPMN. Тип задачи определяется атрибутом **`zeebe:taskDefinition type`**.
- **Конфигурация задачи** — набор метаданных, табов, компонентов, решений (для UserTask) или I/O‑контракт (для ServiceTask), используемых фронтом/движком.
- **Реестр (Registry)** — справочник значений, общий для всех проектов тенанта, с собственным версионированием.
- **Пресет (Preset)** — заготовка (шаблон) конфигурации задачи/компонента/части конфигурации, версионируемая на уровне тенанта.
- **Release** — атомарный снапшот состояния проекта, продвигаемый по цепочке окружений.
- **Rollback** — откат окружения проекта к предыдущему Release.
- **SpEL** — выражения для управления видимостью/доступностью/обязательностью/readonly (UserTask).
- **FEEL** — выражения в значениях I/O‑маппинга ServiceTask (строки, начинающиеся с `=`).

---

## 2. Область охвата и границы
2.1. Система покрывает конфигурирование и версионирование **UserTask** и **ServiceTask** для проектов Camunda 8/Zeebe.

2.2. Система **обязана** обеспечивать:
- Импорт/хранение BPMN‑схем проектов (вариант A) и автогенерацию черновиков конфигураций по новым нодам.
- Ведение конфигураций UserTask (структура экранов, компоненты, решения, SpEL‑правила).
- Ведение конфигураций ServiceTask (тип, I/O‑маппинг по `zeebe:ioMapping`).
- Управление реестрами и пресетами на уровне тенанта.
- Релизный цикл настраиваемой цепочки окружений per‑tenant с откатами.
- Импорт/экспорт и копирование проектов между тенантами.
- Аудит изменений и базовые тесты конфигураций.
- REST‑интерфейсы для получения конфигураций и снапшотов проектом‑потребителем (движком, фронтом).

2.3. Вне охвата: конкретная реализация движка процессов (исполнение), детальная проверка синтаксиса SpEL/FEEL, управление секретами, интеграционные коннекторы по умолчанию.

---

## 3. Акторы и роли
- **Admin**: полный доступ ко всем тенантам; настройка окружений и цепочек; копирование между тенантами; релизы/rollback; импорт/экспорт; управление пресетами и реестрами; настройка пользователей.
- **Manager**: доступ к назначенным тенантам/проектам; редактирование на `dev`; запуск unit‑тестов; подготовка релиза (без публикации/rollback); работа с пресетами и реестрами в пределах прав тенанта.

Требования:
- Система **обязана** поддерживать разграничение по ролям Admin/Manager согласно матрице прав выше.
- Система **обязана** поддерживать назначение Manager’ов на конкретные тенанты/проекты.

---

## 4. Мульти‑тенантность, проекты, окружения
4.1. **Структура:** один тенант содержит несколько проектов и общие реестры для этих проектов.

4.2. **Окружения per‑tenant:**
- Система **обязана** позволять настраивать перечень окружений и их порядок для каждого тенанта (напр., `[dev, prod]` или `[dev, test, stage, prod]`).
- Продвижение релизов **обязано** происходить строго по цепочке, без пропуска звеньев.
- Редактирование конфигураций разрешено **только** в окружении `dev` данного тенанта.

4.3. **Копирование проектов между тенантами:**
- Система **обязана** поддерживать копирование проекта из исходного в целевой тенант:
  - Переносится **последняя версия** всех конфигураций задач (UserTask/ServiceTask) и актуальное состояние реестров.
  - Если целевой тенант не пуст — система **обязана** предупредить и запросить стратегию (по умолчанию **replace**, опционально **merge** для реестров).

---

## 5. Источник истины: BPMN
5.1. Система **обязана** хранить BPMN‑пакеты проекта (вариант A — внутри сервиса) и отображать их в UI c BPMN‑viewer’ом.

5.2. Идентификация нод:
- **UserTask**: `taskDefinitionKey = processName.userTaskId`.
- **ServiceTask**: `serviceTaskKey = processName.serviceTaskId`, при этом тип берётся из `zeebe:taskDefinition type`.

5.3. Автогенерация:
- При обнаружении в BPMN ноды без конфигурации система **обязана** создавать **черновик** конфигурации:
  - Для UserTask — базовая структура (левая панель, одна группа табов/таб, пустые компоненты), типовой набор решений (accept/reject), статус «Новая».
  - Для ServiceTask — запись с типом из `zeebe:taskDefinition type`, пустыми (опциональными) списками I/O‑маппинга.

5.4. Несоответствия:
- Если конфигурация есть, но в BPMN нода отсутствует — система **обязана** пометить её как «лишнюю» и отразить в чек‑листе.
- Если в BPMN нода есть, а конфигурации нет — система **обязана** отразить как «новую» и предложить создать черновик.

5.5. Навигация:
- Клик по ноде в BPMN‑viewer **обязан** открывать редактор соответствующей конфигурации (или создавать черновик и открывать).
- Система **обязана** иметь мастер «Создать черновики для всех отсутствующих нод» на уровне процесса/проекта.

---

## 6. Конфигурация UserTask — требования
6.1. **Метаданные задачи:**
- Этап (информационный атрибут; формируется в процессе, см. ServiceTask SetStage).
- Название задачи (для плиток в кабинетах).
- Текст задачи (пояснение пользователю, что нужно сделать).
- Группа исполнителей (выбор из ролевой модели проекта/тенанта).
- Группа руководителей (выбор из ролевой модели проекта/тенанта).

6.2. **Решения (Decisions):**
- Задача **обязана** поддерживать произвольное количество решений (минимум 0, обычно 1–2, иногда 5+).
- Каждое решение **обязано** иметь: `decisionId` (camelCase), `title`, опционально `decisionType` (accept/reject/rework/…); флаг `validate`; политику комментариев и permissions; `properties`.
- На уровне тенанта/проекта **обязан** существовать справочник решений (шаблоны), с возможностью локального override в задаче.

6.3. **Структура экранов:**
- Левая часть: **плоский список** компонентов (например, `taskInfo`).
- Правая часть: иерархия `tabGroups → tabs → components`.
- `pos` — влияет только на порядок отображения; пустых табов быть **не должно**; порядок **обязан** поддерживать drag‑and‑drop в UI.
- Компоненты **обязаны** поддерживать подключение библиотечных заготовок через `_component` (наследование с возможностью переопределений).

6.4. **Компоненты и атрибуты:**
- Базовые поля компонента **не жёстко фиксированы** и могут отличаться по проектам/версиям; система **обязана** позволять конфигурировать набор полей и их значения.
- Допускаются тип‑специфичные атрибуты (например, для компонента документов — массив `types`, ссылающийся на реестр `docType`).

6.5. **Условия и SpEL:**
- Для любых элементов (tabGroup/tab/component/поле) система **обязана** поддерживать управление:
  - `visible` / `enabled` / `required` / `readonly`
  - значения — булево или строка SpEL (без глубокой статической проверки на старте).

6.6. **Идентификаторы:**
- Внутри задачи `tabGroupId`, `tabId`, `componentId`, `decisionId` — в camelCase, уникальны в пределах задачи.
- Переименование указанных id в опубликованных задачах **разрешено**; система **обязана** выполнять автоматическую миграцию внутренних ссылок в пределах задачи и предупреждать о возможных внешних ссылках.

6.7. **Юнит‑тесты конфигураций UserTask:**
- Система **обязана** поддерживать хранение и запуск тестов в формате JSON: ручной запуск и обязательный запуск при релизе.
- Базовые проверки **обязаны** включать: уникальность id; валидность ссылок на `_component`/реестры; наличие обязательных разделов (без пустых табов); соответствие наличию ноды в BPMN.

---

## 7. Конфигурация ServiceTask — требования
7.1. **Тип сервистаски:**
- Тип **обязан** считываться из `zeebe:taskDefinition type` и храниться в конфигурации как строка.

7.2. **I/O‑маппинг (zeebe:ioMapping):**
- Входы (`zeebe:input`) и выходы (`zeebe:output`) **могут отсутствовать** частично или полностью — система **обязана** это поддерживать.
- Элементы I/O‑маппинга **обязаны** поддерживать значения двух видов:
  - `string` (обычная строка);
  - `feelExpression` — строка, начинающаяся с `=` (интерпретируется движком как FEEL‑выражение).
- Конфигурация **обязана** хранить пары ввода/вывода с полями: для `input` — `{name, value}`; для `output` — `{source, target}`.
- Система **обязана** предоставлять UI для редактирования таблиц inputs/outputs с подсветкой FEEL и базовой проверкой «не пусто».

7.3. **Этап (Stage) как информационный атрибут:**
- Установка Этапа осуществляется отдельной ServiceTask (типа, заданного в BPMN). Значение этапа — строка или FEEL, записываемая в целевую переменную через `output`.
- Этап **не влияет** на SpEL/логику отображения; используется исключительно как информационный атрибут.

7.4. **Версионирование и тесты:**
- Конфигурации ServiceTask **обязаны** версионироваться как и UserTask.
- При релизе система **обязана** включать их в снэпшот и откатывать вместе с проектом.
- Unit‑тесты **обязаны** поддерживать базовые проверки корректности I/O‑маппинга (если задан): отсутствие дубликатов имён таргетов; непустые `target`.

---

## 8. Реестры (Registries) — требования
8.1. **Общность:** реестры **общие** для всех проектов внутри одного тенанта.

8.2. **Версионирование:** каждый реестр **обязан** иметь собственные версии и журнал изменений; изменения на `dev` вступают в силу немедленно; релиз проекта переносит состояния реестров по цепочке окружений тенанта.

8.3. **Без ограничений по количеству:** система **обязана** поддерживать любое число реестров (например, `roles`, `docType`, и прочие бизнес‑справочники).

8.4. **Импорт/экспорт:** система **обязана** поддерживать импорт/экспорт реестров в JSON с режимами **replace** и **merge** (merge — по `itemId`: обновить совпадающие, добавить новые, не удалять отсутствующие).

---

## 9. Пресеты (Presets) — требования
9.1. Пресеты **обязаны** храниться на уровне тенанта и иметь собственные версии и журнал изменений.

9.2. Виды пресетов:
- Пресеты задач (каркасы UserTask).
- Пресеты компонентов (`_component`).
- (Опционально на будущее) Пресеты ServiceTask.

9.3. Применимость:
- Система **обязана** позволять создавать задачи/компоненты из пресетов и впоследствии их редактировать.

---

## 10. Импорт/экспорт, копирование — требования
10.1. **Уровни:** проект целиком; отдельный процесс; отдельная задача (UserTask/ServiceTask); отдельный реестр; набор пресетов.

10.2. **Формат:** JSON.

10.3. **Режимы импорта:**
- При импорте система **обязана** запрашивать режим **replace** или **merge** (для реестров — merge по `itemId`). По умолчанию — **replace**.

10.4. **Копирование проектов между тенантами:**
- Переносятся **последние версии** конфигураций задач и актуальные состояния реестров.
- Если целевой тенант не пуст, система **обязана** предупредить и запросить стратегию слияния (базово — **replace**).

---

## 11. Релизы и откаты — требования
11.1. **Создание релиза:**
- Релиз может быть создан **только** из окружения `dev` текущего тенанта.
- Релиз **обязан** включать атомарный снапшот: все **последние версии** конфигураций UserTask и ServiceTask проекта + текущие состояния реестров тенанта.
- Релиз **обязан** иметь Release Notes: тег/номер, название, описание, автор, дата, перечень изменений (задачи/сервис‑таски/реестры/пресеты).

11.2. **Продвижение релиза:**
- Promote **обязан** происходить **только** на следующее окружение согласно цепочке окружений тенанта.

11.3. **Откат:**
- Система **обязана** поддерживать Rollback релиза для любого окружения, откатываясь к предыдущему успешно опубликованному релизу.

11.4. **Чек‑лист готовности перед публикацией:**
- Отсутствие «лишних» конфигураций.
- Отсутствие пустых табов.
- Валидность ссылок на `_component` и реестры.
- Успешное прохождение unit‑тестов проекта.

---

## 12. Аудит и хранение истории — требования
12.1. Система **обязана** вести аудит всех изменений конфигураций, реестров и пресетов: кто, когда, какой объект, какие поля (сводно).

12.2. Срок хранения — **1 год**.

12.3. UI‑фильтры по дате, автору, типу объекта.

12.4. Diff‑viewer на старте **не обязателен**.

---

## 13. Идентификаторы и именование — требования
13.1. На уровне задачи — уникальные `tabGroupId`, `tabId`, `componentId`, `decisionId` в camelCase.

13.2. На уровне тенанта — уникальные `registryId` и идентификаторы пресетов в camelCase.

13.3. **Переименование** указанных id **разрешено**; система **обязана** мигрировать внутренние ссылки в пределах сущности и предупреждать о возможных внешних.

---

## 14. Валидация и ограничения на старте
14.1. Для SpEL — система **не обязана** выполнять глубокую статическую проверку синтаксиса (минимум: непустая строка, базовая валидация заполненности ключей фронтом).

14.2. Для FEEL — система **не обязана** выполнять парсинг; минимальная проверка — обнаружение префикса `=` и непустого значения.

14.3. JSON Schema для типов компонентов — **зарезервировано** на будущее, не обязательно на старте.

---

## 15. UI/UX — функциональные требования
15.1. **BPMN Viewer**:
- Отображение процесса с подсветкой статусов нод: «сконфигурирована», «новая», «лишняя».
- Переход по клику к редактору конфигурации ноды; создание черновика при отсутствии.
- Мастер «Создать черновики для всех отсутствующих нод».

15.2. **Редактор UserTask**:
- Дерево: левая панель (плоские компоненты), правая панель (`tabGroups→tabs→components`).
- Drag‑and‑drop упорядочивание; запрет пустых табов.
- Форма редактирования решений (из справочника с override) и SpEL‑правил на любом уровне.
- Подключение `_component` и переопределение атрибутов.

15.3. **Редактор ServiceTask**:
- Просмотр/редактирование `type` (только чтение — из BPMN) и `ioMapping` (таблицы inputs/outputs), поддержка `string` и `feelExpression` (подсветка по `=`).
- Разрешение пустых списков inputs/outputs.

15.4. **Реестры и пресеты**:
- Списки, версии, журнал изменений; импорт/экспорт (JSON) с режимами replace/merge.
- Применение пресетов при создании задач/компонентов.

15.5. **Релизы**:
- Экран составления релиза из `dev` с Release Notes, запуском unit‑тестов и чек‑листом готовности.
- Promote по цепочке окружений тенанта; Rollback к предыдущему релизу.

15.6. **Аудит**:
- Просмотр истории с фильтрами; срок хранения 1 год.

---

## 16. Интеграционные требования (функциональные интерфейсы)
16.1. Система **обязана** предоставлять REST‑интерфейсы для потребителей (движок, фронт) минимум со следующими возможностями:
- Получение конфигурации **UserTask** по `taskDefinitionKey` для конкретного тенанта/проекта/окружения.
- Получение конфигурации **ServiceTask** по `serviceTaskKey` для конкретного тенанта/проекта/окружения.
- Получение **снапшота проекта** (UserTask + ServiceTask + ссылки/состояния реестров) с опцией включать/не включать BPMN‑файлы.
- Получение состояния **реестра** по `registryId`.
- Загрузка/получение BPMN‑пакетов проекта.
- Операции **Release**: создание из `dev`, продвижение на следующее окружение цепочки, откат на окружении.
- Импорт/экспорт конфигураций и реестров в JSON; копирование проекта между тенантами.
- Отправка **webhook‑уведомлений** подписчикам о публикации релиза.

Примечание: конкретные URI/форматы полезной нагрузки не навязываются данным FRD, но перечисленные функции **обязаны** быть доступны.

---

## 17. Нефункциональные ограничения и допущения (уровень требований)
17.1. **Язык интерфейса и контента:** русский; локализация не требуется.

17.2. **Масштаб:** ориентировочно до 100 проектов на инсталляцию, 10–50 процессов в каждом проекте, 10–20 задач в каждом процессе.

17.3. **Производительность:** специальных требований к кэшированию на старте нет; система должна обеспечивать приемлемый отклик UI при заявленном масштабе.

17.4. **Совместимость:** поддержка Camunda 8 / Zeebe как источника BPMN и потребителя конфигураций; обязательна визуализация BPMN в UI.

17.5. **Безопасность:** разграничение прав по ролям Admin/Manager; аудит изменений (1 год).

17.6. **Согласованность окружений:** набор окружений и их порядок — настраиваемы per‑tenant; редактирование — только на `dev`.

---

## 18. Критерии приёмки (высокоуровневые)
- Импорт BPMN → автоматическое обнаружение нод и создание черновиков для отсутствующих UserTask/ServiceTask.
- Возможность редактирования конфигураций UserTask (структура экранов, компоненты, решения, SpEL) и ServiceTask (тип, I/O‑маппинг) на `dev`.
- Наличие реестров и пресетов на уровне тенанта с версиями, журналом и импортом/экспортом.
- Корректная работа мастера «создать черновики для всех отсутствующих нод» и навигации из BPMN в редакторы.
- Успешное формирование Release из `dev`, его продвижение по цепочке окружений и Rollback на выбранном окружении.
- Рабочие REST‑интерфейсы для выборки конфигураций задач/снапшота/реестров.
- Полный аудит изменений с хранением 1 год.
- Прохождение базовых unit‑тестов конфигураций при релизе.

---

## 19. Открытые вопросы (зафиксированные)
- Глубокая статическая валидация SpEL/FEEL — отложена (не обязательна на старте).
- JSON Schema для типов компонентов — отложено; требуется проработка типизации и валидаторов.
- Политика внешних ссылок при переименовании id — на старте предупреждением без автопереноса; может потребовать расширения.

---

## 20. Приложение A — Требования к идентификаторам
- Все идентификаторы в рамках своих областей должны быть уникальны и оформлены в **camelCase**.
- Разрешено переименование с автоматической миграцией внутренних ссылок и предупреждением о возможных внешних.
- `taskDefinitionKey`/`serviceTaskKey` должны формироваться из BPMN в формате `processName.userTaskId`/`processName.serviceTaskId` соответственно.

Вся текстовка должна быть на русском языке!